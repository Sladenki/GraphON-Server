# üìä –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ —á–µ—Ä–µ–∑ API.

## –ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è

- **DAU** (Daily Active Users) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞ –¥–µ–Ω—å
- **WAU** (Weekly Active Users) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞ –Ω–µ–¥–µ–ª—é
- **MAU** (Monthly Active Users) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞ –º–µ—Å—è—Ü
- **–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** –∑–∞ –¥–µ–Ω—å
- **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º** –∑–∞ –ø–µ—Ä–∏–æ–¥
- **–¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–∫–∏–Ω–≥**: –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ middleware
2. **–•—Ä–∞–Ω–µ–Ω–∏–µ**: –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ MongoDB (–∫–æ–ª–ª–µ–∫—Ü–∏—è `user_activities`)
3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –≤ Redis –Ω–∞ 1 —á–∞—Å
4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏–Ω–¥–µ–∫—Å—ã MongoDB –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## API Endpoints

–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–æ–ª–µ–π `admin` –∏ `sysadmin`.

### 1. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```
GET /analytics/overall
```

–û—Ç–≤–µ—Ç:
```json
{
  "totalUsers": 1500,
  "dau": {
    "today": 250,
    "yesterday": 230,
    "change": 8.7
  },
  "wau": 800,
  "mau": 1200,
  "newUsersToday": 15
}
```

### 2. DAU (Daily Active Users)
```
GET /analytics/dau?date=2024-01-15
```

–û—Ç–≤–µ—Ç:
```json
{
  "date": "2024-01-15",
  "dau": 250
}
```

### 3. WAU (Weekly Active Users)
```
GET /analytics/wau?date=2024-01-15
```

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ 7 –¥–Ω–µ–π –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ).

–û—Ç–≤–µ—Ç:
```json
{
  "startDate": "2024-01-09",
  "endDate": "2024-01-15",
  "wau": 800
}
```

### 4. MAU (Monthly Active Users)
```
GET /analytics/mau?month=1&year=2024
```

–û—Ç–≤–µ—Ç:
```json
{
  "month": 1,
  "year": 2024,
  "mau": 1200
}
```

### 5. –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
```
GET /analytics/new-users?date=2024-01-15
```

–û—Ç–≤–µ—Ç:
```json
{
  "date": "2024-01-15",
  "newUsers": 15
}
```

### 6. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º
```
GET /analytics/daily-stats?startDate=2024-01-01&endDate=2024-01-31
```

–û—Ç–≤–µ—Ç:
```json
{
  "startDate": "2024-01-01",
  "endDate": "2024-01-31",
  "stats": [
    {
      "date": "2024-01-01T00:00:00.000Z",
      "uniqueUsers": 150,
      "totalRequests": 1250
    },
    {
      "date": "2024-01-02T00:00:00.000Z",
      "uniqueUsers": 180,
      "totalRequests": 1500
    }
  ]
}
```

### 7. –¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```
GET /analytics/top-users?startDate=2024-01-01&endDate=2024-01-31&limit=10
```

–û—Ç–≤–µ—Ç:
```json
{
  "startDate": "2024-01-01",
  "endDate": "2024-01-31",
  "topUsers": [
    {
      "userId": "507f1f77bcf86cd799439011",
      "firstName": "–ò–≤–∞–Ω",
      "lastName": "–ü–µ—Ç—Ä–æ–≤",
      "username": "ivan_petrov",
      "totalDays": 28,
      "totalRequests": 450
    }
  ]
}
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ —Å–µ–≥–æ–¥–Ω—è
```bash
curl -X GET "http://localhost:3000/analytics/overall" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
```bash
curl -X GET "http://localhost:3000/analytics/daily-stats?startDate=2024-01-01&endDate=2024-01-31" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ø-10 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```bash
curl -X GET "http://localhost:3000/analytics/top-users?startDate=2024-01-01&endDate=2024-01-31&limit=10" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ö–æ–ª–ª–µ–∫—Ü–∏—è: user_activities

```typescript
{
  userId: ObjectId,           // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  date: Date,                 // –î–∞—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–Ω–∞—á–∞–ª–æ –¥–Ω—è)
  requestCount: Number,       // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
  firstSeenAt: Date,          // –ü–µ—Ä–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
  lastSeenAt: Date            // –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
}
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `{ userId: 1, date: 1 }` (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
- `{ date: 1 }`
- `{ userId: 1 }`

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ User

–í `UserModel` –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ:
```typescript
lastActivityDate?: Date  // –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- ‚úÖ –¢—Ä–µ–∫–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å
- ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ **–∫—ç—à–∏—Ä—É—é—Ç—Å—è –≤ Redis** –Ω–∞ 1 —á–∞—Å
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **—Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã** –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ê–≥—Ä–µ–≥–∞—Ü–∏–∏ MongoDB –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–û—à–∏–±–∫–∏ —Ç—Ä–µ–∫–∏–Ω–≥–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```
Failed to track user activity: [error details]
```

## –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:
- **–¢–µ–∫—É—â–∏–π –¥–µ–Ω—å**: 1 —á–∞—Å
- **–ü—Ä–æ—à–ª—ã–µ –¥–Ω–∏**: 1 —á–∞—Å
- **–ü—Ä–æ—à–ª—ã–µ –º–µ—Å—è—Ü—ã**: 7 –¥–Ω–µ–π (–¥–ª—è MAU)

–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ

–õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ `AnalyticsService`:

```typescript
async getCustomMetric(): Promise<any> {
  // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞
  return await this.UserActivityModel.aggregate([...]).exec();
}
```

–ò —Å–æ–∑–¥–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç –≤ `AnalyticsController`:

```typescript
@AuthWithRoles('admin', 'sysadmin')
@Get('custom-metric')
async getCustomMetric() {
  return this.analyticsService.getCustomMetric();
}
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- ‚úÖ MongoDB (–¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö)
- ‚úÖ Redis (–¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è)
- ‚úÖ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∑–∞—â–∏—â–µ–Ω—ã –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º `@AuthWithRoles('admin', 'sysadmin')`
- –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –ø–æ–ª—É—á–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É
- –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –≤–∞—à–µ–º —Å–µ—Ä–≤–µ—Ä–µ

## Troubleshooting

### –ù–µ —Ç—Ä–µ–∫–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ middleware –ø–æ–¥–∫–ª—é—á–µ–Ω –≤ `app.module.ts`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (–µ—Å—Ç—å JWT —Ç–æ–∫–µ–Ω)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∫–æ–Ω—Å–æ–ª–∏ –Ω–∞ –æ—à–∏–±–∫–∏

### –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –≤ MongoDB
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ Redis
3. –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –ø–µ—Ä–∏–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ (–Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–µ—Ç —Å—Ä–∞–∑—É)

### –ö—ç—à –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `RedisService` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ TTL –∫—ç—à–∞

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] Retention rate (–≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- [ ] Peak hours (–ø–∏–∫–æ–≤—ã–µ —á–∞—Å—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
- [ ] –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –ê–Ω–∞–ª–∏–∑ –ø—É—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV/Excel
- [ ] –î–∞—à–±–æ—Ä–¥ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏

